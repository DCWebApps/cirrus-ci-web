container:
  image: node:12

build_task:
  use_compute_credits: $CIRRUS_BRANCH == 'master'
  node_modules_cache:
    folder: node_modules
    fingerprint_script: cat package-lock.json
    populate_script: npm ci
  relay_script: npm run relay
  build_script: npm run build

makisu_docker_task:
  env:
    CIRRUS_SHELL: direct
    CIRRUS_WORKING_DIR: /makisu-context
  container:
    image: gcr.io/makisu-project/makisu:v0.1.11
  build_script:
    /makisu-internal/makisu build
      --http-cache-addr="http://$CIRRUS_HTTP_CACHE_HOST"
      --tag cirrusci/web-front-end:makisu
      --commit=explicit
      --modifyfs=true
      /makisu-context

makisu_push_task:
  environment:
    DOCKER_CONFIG: ENCRYPTED[058fb42cbf79a6b0c0f29ef5adab49440cbe49a61a6f622351cddc1b478ac0bd46508eed6927e1ae3c02197e8f06e0c9]
  env:
    CIRRUS_SHELL: direct
    CIRRUS_WORKING_DIR: /makisu-context
  container:
    image: gcr.io/makisu-project/makisu:v0.1.11
  docker_config_file:
    path: /root/.docker/config
    variable_name: DOCKER_CONFIG
  build_script:
    /makisu-internal/makisu build
      --http-cache-addr="http://$CIRRUS_HTTP_CACHE_HOST"
      --registry-config=/root/.docker/config
      --tag cirrusci/web-front-end:makisu
      --commit=explicit
      --modifyfs=true
      --push=index.docker.io
      /makisu-context
